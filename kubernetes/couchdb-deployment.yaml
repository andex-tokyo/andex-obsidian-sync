# kubernetes/couchdb-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: couchdb
  namespace: obsidian-sync
spec:
  replicas: 1
  selector:
    matchLabels:
      app: couchdb
  template:
    metadata:
      labels:
        app: couchdb
    spec:
      containers:
        - name: couchdb
          image: couchdb:3.5.0
          env:
            - name: COUCHDB_USER
              value: "admin"
            - name: COUCHDB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: couchdb-secrets
                  key: admin-password
            - name: COUCHDB_SECRET
              valueFrom:
                secretKeyRef:
                  name: couchdb-secrets
                  key: cookie

          ports:
            - containerPort: 5984
              name: couchdb

          volumeMounts:
            - name: couchdb-data
              mountPath: /opt/couchdb/data
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "1Gi"
              cpu: "500m"

        # サイドカーコンテナとして設定スクリプトを実行
        - name: couchdb-configurator
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |

              hostname="http://localhost:5984"
              username="admin"
              password="${COUCHDB_PASSWORD}"

              echo "Waiting for CouchDB to be ready..."
              for i in $(seq 1 60); do
                if curl -s -f "${hostname}/_up" > /dev/null 2>&1; then
                  echo "CouchDB is ready!"
                  break
                fi
                echo "Attempt $i..."
                sleep 5
              done

              echo "-- Configuring CouchDB by REST APIs... -->"

              # 設定チェック：既に設定済みかどうか確認
              if curl -s -u "${username}:${password}" "${hostname}/_node/nonode@nohost/_config/cors/origins" | grep -q "obsidian"; then
                echo "CouchDB already configured, skipping setup"
                # 設定済みの場合は無限ループで待機（サイドカーとして動作継続）
                while true; do sleep 86400; done
              fi

              echo "Starting fresh configuration..."

              until (curl -X POST "${hostname}/_cluster_setup" -H "Content-Type: application/json" -d "{\"action\":\"enable_single_node\",\"username\":\"${username}\",\"password\":\"${password}\",\"bind_address\":\"0.0.0.0\",\"port\":5984,\"singlenode\":true}" --user "${username}:${password}"); do sleep 5; done

              until (curl -X PUT "${hostname}/_node/nonode@nohost/_config/chttpd/require_valid_user" -H "Content-Type: application/json" -d '"true"' --user "${username}:${password}"); do sleep 5; done

              until (curl -X PUT "${hostname}/_node/nonode@nohost/_config/chttpd_auth/require_valid_user" -H "Content-Type: application/json" -d '"true"' --user "${username}:${password}"); do sleep 5; done

              until (curl -X PUT "${hostname}/_node/nonode@nohost/_config/httpd/WWW-Authenticate" -H "Content-Type: application/json" -d '"Basic realm=\"couchdb\""' --user "${username}:${password}"); do sleep 5; done

              until (curl -X PUT "${hostname}/_node/nonode@nohost/_config/httpd/enable_cors" -H "Content-Type: application/json" -d '"true"' --user "${username}:${password}"); do sleep 5; done

              until (curl -X PUT "${hostname}/_node/nonode@nohost/_config/chttpd/enable_cors" -H "Content-Type: application/json" -d '"true"' --user "${username}:${password}"); do sleep 5; done

              until (curl -X PUT "${hostname}/_node/nonode@nohost/_config/chttpd/max_http_request_size" -H "Content-Type: application/json" -d '"4294967296"' --user "${username}:${password}"); do sleep 5; done

              until (curl -X PUT "${hostname}/_node/nonode@nohost/_config/couchdb/max_document_size" -H "Content-Type: application/json" -d '"50000000"' --user "${username}:${password}"); do sleep 5; done

              until (curl -X PUT "${hostname}/_node/nonode@nohost/_config/cors/credentials" -H "Content-Type: application/json" -d '"true"' --user "${username}:${password}"); do sleep 5; done

              until (curl -X PUT "${hostname}/_node/nonode@nohost/_config/cors/origins" -H "Content-Type: application/json" -d '"app://obsidian.md,capacitor://localhost,http://localhost"' --user "${username}:${password}"); do sleep 5; done

              echo "<-- Configuring CouchDB by REST APIs Done!"

              # 設定確認
              echo "=== Configuration verification ==="
              curl -u "${username}:${password}" "${hostname}/_node/nonode@nohost/_config/cors"

              # ユーザー作成
              echo "Creating additional user..."
              
              # ユーザー1を作成（adminは既存なので追加ユーザーのみ）
              user1_name="risako"
              user1_password="${USER1_PASSWORD}"
              user1_db="risako-ob"

              # ユーザー1が既に存在するかチェック
              if curl -s -u "${username}:${password}" "${hostname}/_users/org.couchdb.user:${user1_name}" | grep -q "${user1_name}"; then
                echo "User ${user1_name} already exists, skipping user creation"
              else
                echo "Creating user: ${user1_name}"
                curl -X PUT "${hostname}/_users/org.couchdb.user:${user1_name}" \
                  -H "Content-Type: application/json" \
                  -d "{\"name\":\"${user1_name}\",\"password\":\"${user1_password}\",\"roles\":[],\"type\":\"user\"}" \
                  --user "${username}:${password}"
              fi
              
              # データベースが既に存在するかチェック
              if curl -s -u "${username}:${password}" "${hostname}/${user1_db}" | grep -q "db_name"; then
                echo "Database ${user1_db} already exists, skipping database creation"
              else
                echo "Creating database: ${user1_db}"
                curl -X PUT "${hostname}/${user1_db}" \
                  --user "${username}:${password}"
                
                curl -X PUT "${hostname}/${user1_db}/_security" \
                  -H "Content-Type: application/json" \
                  -d "{\"admins\":{\"names\":[],\"roles\":[]},\"members\":{\"names\":[\"${user1_name}\"],\"roles\":[]}}" \
                  --user "${username}:${password}"
              fi
              
              echo "User setup completed!"
              echo "Available users:"
              echo "  - admin (existing data)"
              echo "  - user1 (new database: ${user1_db})"
              
              # 設定完了後は無限ループで待機（サイドカーとして動作継続）
              echo "Configuration completed, entering maintenance mode..."
              while true; do sleep 86400; done

          env:
            - name: COUCHDB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: couchdb-secrets
                  key: admin-password
            - name: USER1_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: couchdb-secrets
                  key: user1-password

      volumes:
        - name: couchdb-data
          persistentVolumeClaim:
            claimName: couchdb-data-pvc

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: couchdb-data-pvc
  namespace: obsidian-sync
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
